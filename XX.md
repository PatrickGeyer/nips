NIP-XX - Escrow
======
`draft` `optional` `author:PatrickGeyer` 

The purpose of this NIP is to allow two users of the nostr network to agree on an escrow service to sit inbetween a value transfer. Reputation systems might be helpful, but for marketplace, hotel bookings and ride-sharing, stronger guarantees might be needed.

------------------
## Terms

- `buyer` - user initiating a transfer of value
- `seller` - user receiving a transfer of value
- `escrow` - entity which can complete or reverse the associated payment

An escrow can publish these events:
| Kind    |                  | Description                                                                                                   | NIP                                     |
|---------|------------------|---------------------------------------------------------------------------------------------------------------|-----------------------------------------|
| `0    ` | `set_meta`       | Announces itself (similar with any `nostr` public key).                                               | [NIP01       ](https://github.com/nostr-protocol/nips/blob/master/01.md)                            |
| `30020` | `set_service`      | Create or update an escrow service.                                                                                     | [NIP33](https://github.com/nostr-protocol/nips/blob/master/33.md) (Parameterized Replaceable Event) |
| `4    ` | `direct_message` | Communicate with the customer. The messages can be plain-text or JSON. | [NIP09](https://github.com/nostr-protocol/nips/blob/master/09.md)                                            |
| `5    ` | `delete`         | Delete an escrow service.                                                                                  | [NIP05](https://github.com/nostr-protocol/nips/blob/master/05.md)                                   |

### Event `30020`: Create or update a escrow service.

**Event Content**:
```json
{
    "id": <String, UUID generated by the escrow. Sequential IDs (`0`, `1`, `2`...) are discouraged>,
    "type": <String, option type e.g. hodl invoice>,
    "link": <String, url, btc address, ln invoice, lightning address, lightning node id, etc>,
    "max_block_timeout": <uint (optional), stall description>,
    "max_amount": <float, >
    "max_amount_currency": <String, >
    "url": <String, website where users can find out more about relay service>,
    "nips": [15, ..] <uint[] list of NIPs that this escrow negatiates transactions for>
}
```

A buyer and seller will both publish an event to indicate agreement on a specific escrow service. They do not need to do this at the time of trade. Like looking up who a nostr user follows, clients can lookup which escrows a user trusts.

| Kind    |                  | Description                                                                                                   | NIP                                     |
|---------|------------------|---------------------------------------------------------------------------------------------------------------|-----------------------------------------|
| `7    ` | `reaction`       | Announce agreement to an escrow service. Reference event id of escrow service announcement                                | [NIP07       ](https://github.com/nostr-protocol/nips/blob/master/07.md)                            |

Apps that use nostr escrows could automatically signal trust in a default escrow service on behalf of a user for the sake of ease of use.
E.g. A marketplace nostr app might run its own escrow service as well.
When the buyer is browsing a seller's stall on a client, the client will match up escrow services that the buyer and seller both trust.
It then knows which payment methods are available. If the seller has not indicated support for any escrows, the client should indicate that escrow is not available for this transaction and direct payment is the only option.

When the buyer wants to initiate a payment, it sends an event with an escrow tag attached. 
For example, when sending an order to a marketplace with a NIP 15 message: 

```json
"content": "{ "items": [...]}",
"tags": [
       ["escrow", <String, id of escrow service],
       ...
    ]

```
This is to allow the buyer to choose the escrow for this transaction. 

The buyer or the seller can now initiate an escrow transaction by direct messaging the escrow. 

```json
"tags": [["e", <String, id of buyer's message, eg. NIP-15 checkout message>], ["escrow", <String, id of escrow service announcement event>]],
"content": {
    "id": <String, UUID generated by the customer>,
    "type": 0, // Initiate escrow transaction,
    "payment_hash": <String, optional hash of an ln invoice>,
    "amount": <float, >,
    "amount_currency: <String, >
}

```
The `buyer` and the `seller` can exchange JSON messages with the escrow that represent different actions. Each `JSON` message `MUST` have a `type` field indicating the what the JSON represents. Possible types:

| Message Type | Sent By      | Description                   |
|--------------|--------------|-------------------------------|
| 0            | Seller/Buyer | Initiate escrow transactions  |
| 1            | Escrow       | Payment Request               |
| 2            | Escrow       | Payment Updated               |
| 3            | Seller       | Refund escrow transaction     |
| 4            | Escrow       | Usage Fee Request             |

The escrow can then direct message the buyer with the following message: 
```json
"tags": [["e", <String, event id of original order message>]]
"content": 
{
    "id": <String, UUID of the order>,
    "type": 1,
    "message": <String, message to customer, optional>,
    "payment_options": [
        {
            "type": <String, option type>,
            "link": <String, url, btc address, ln invoice, etc>
        },
        {
            "type": <String, option type>,
            "link": <String, url, btc address, ln invoice, etc>
        },
                {
            "type": <String, option type>,
            "link": <String, url, btc address, ln invoice, etc>
        }
    ]
}
```

The buyer then satisfies the payment.

The escrow, upon payment receipt, then sends direct messages to both buyer and seller
```json
{
    "id": <String, UUID of the order>,
    "type": 1,
    "message": RECEIVED/DISPUTED/REVERSED/SETTLED/CANCELLED,
    "proof": <String, optional proof of payment e.g. preimage>
}
```

If there is a dispute, both seller and buyer can direct message the escrow before the payment times out.

In addition, the escrow can send a type: 4 message requiring a small payment in order to provide the service.